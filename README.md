# 服务器Ping监控系统 - 详细文档

## 📋 目录

1. [系统简介](#系统简介)
2. [功能特性](#功能特性)
3. [快速开始](#快速开始)
4. [配置说明](#配置说明)
5. [使用指南](#使用指南)
6. [常见问题](#常见问题)
7. [技术架构](#技术架构)

---

## 系统简介

服务器Ping监控系统是一个基于Java开发的自动化监控工具，用于持续监控服务器网络连通性。系统会定期执行ping检测，记录监控数据，生成Excel报表，并通过邮件发送告警信息。

### 主要功能

- ✅ **自动Ping监控**：按配置的时间间隔自动ping服务器列表
- ✅ **智能重试机制**：ping超时时自动重试2次（总共3次尝试），减少因临时网络波动导致的误报
- ✅ **数据记录**：自动记录监控数据到Excel和TXT文件
- ✅ **邮件告警**：支持多种邮件发送模式
- ✅ **指定时间点ping**：每天在指定时间点执行ping并发送结果（无论是否有异常都发送）

---

## 功能特性

### 1. 灵活的监控间隔

- 支持自定义Ping间隔时间（1分钟、5分钟、1小时等）
- 所有配置都在 `application.yml` 文件中，方便修改

### 1.1. 智能重试机制

- **自动重试**：当ping出现超时时，系统会自动重试2次（总共3次尝试）
- **减少误报**：只有连续3次都失败才标记为异常并发送邮件告警
- **重试间隔**：每次重试间隔2秒，避免频繁重试
- **适用场景**：适合处理临时网络波动、网络抖动等偶发性问题

**工作流程：**
1. 第1次尝试：执行ping，如果成功则直接记录成功
2. 第2次尝试：如果第1次失败，等待2秒后重试
3. 第3次尝试：如果第2次仍失败，等待2秒后最后一次尝试
4. 最终判定：只有3次都失败才标记为异常并发送告警邮件

### 2. 邮件发送模式

- **ON_FAILURE**：仅在检测到异常时发送（推荐）
- **ON_FAILURE_AND_MORNING_SUMMARY**：在检测到异常时立即发送；并在指定时间点（可配置，默认7:00）执行一次ping检测，将结果发送到邮件（无论是否有异常都发送）

### 3. 指定时间点ping

- 在指定时间点（如7:00）执行一次ping检测，并将结果发送到邮件
- **无论是否有异常都会发送邮件**，确保在固定时间点了解服务器状态
- 同样支持重试机制，减少误报

### 4. 数据记录

- **Excel报表**：按月生成，包含所有监控数据
- **TXT日志**：按天生成，包含详细的ping命令输出
- 自动按月份组织文件结构
- **数据安全机制**：Excel写入使用临时文件+原子替换，确保写入失败时不会丢失已有数据

---

## 快速开始

### 环境要求

- JDK 17 或更高版本
- Maven 3.6+
- Windows 或 Linux 系统

### 安装步骤

1. **克隆或下载项目**
   ```bash
   cd demo
   ```

2. **配置服务器列表**
   
   在项目根目录创建 `server_list.txt` 文件，每行一个IP或域名：
   ```
   # 服务器IP列表（每行一个IP或域名）
   # 以#开头的行为注释
   192.168.1.1
   8.8.8.8
   www.baidu.com
   ```

3. **配置邮件和监控参数**
   
   编辑 `src/main/resources/application.yml` 文件，填写必要的配置（见下方配置说明）

4. **编译项目**
   ```bash
   mvn clean package
   ```

5. **运行程序**
   ```bash
   java -jar target/demo-0.0.1-SNAPSHOT.jar
   ```
   
   或者使用Spring Boot方式：
   ```bash
   mvn spring-boot:run
   ```

---

## 配置说明

### 配置文件位置

所有配置都在 `src/main/resources/application.yml` 文件中。

### 配置项详解

#### 1. Ping监控配置

```yaml
monitor:
  ping:
    interval: 60000  # Ping监控间隔时间（毫秒）
    timeout: 3000    # Ping超时时间（毫秒）
```

**说明：**
- `interval`：监控间隔时间，单位毫秒
  - `60000` = 1分钟
  - `300000` = 5分钟
  - `600000` = 10分钟
  - `3600000` = 1小时
- `timeout`：ping超时时间，单位毫秒，默认3秒

**示例：**
```yaml
# 每5分钟ping一次
interval: 300000

# 每1小时ping一次
interval: 3600000
```

#### 2. 指定时间点ping配置

```yaml
monitor:
  daily-summary:
    hour: 7     # 执行ping的时间：小时（0-23），默认早上7点
    minute: 0   # 执行ping的时间：分钟（0-59）
```

**功能说明：**
- 当 `email.send-mode` 设置为 `ON_FAILURE_AND_MORNING_SUMMARY` 时生效
- 在指定时间点执行一次ping检测，并将结果发送到邮件
- **无论是否有异常都会发送邮件**，确保在固定时间点了解服务器状态
- **使用场景**：异常时即时告警 + 在固定时间点主动检查服务器状态

**示例：**
```yaml
# 每天早上7点执行ping并发送结果
hour: 7
minute: 0

# 每天早上8点30分执行ping并发送结果
hour: 8
minute: 30
```

#### 3. 邮件基本配置

```yaml
email:
  enabled: true              # 是否启用邮件通知
  send-mode: ON_FAILURE_AND_MORNING_SUMMARY      # 邮件发送模式
```

**邮件发送模式说明：**
- `ON_FAILURE`：仅在检测到异常时发送（推荐，避免邮件过多）
- `ON_FAILURE_AND_MORNING_SUMMARY`：在检测到异常时发送 + 在指定时间点执行ping并发送结果（无论是否有异常都发送，配合 `monitor.daily-summary` 配置使用）

#### 5. SMTP服务器配置

```yaml
email:
  smtp:
    host: smtp.office365.com  # SMTP服务器地址
    port: 587                  # SMTP端口
    starttls-enable: true      # 是否启用STARTTLS加密
    auth: true                  # 是否启用认证
```

**不同邮件服务商的配置：**

| 邮件服务商 | SMTP服务器 | 端口 | 说明 |
|-----------|-----------|------|------|
| Office365/Outlook | smtp.office365.com | 587 | 使用邮箱密码 |
| Gmail | smtp.gmail.com | 587 | 需要使用应用专用密码 |
| QQ邮箱 | smtp.qq.com | 587 | 需要使用授权码 |
| 163邮箱 | smtp.163.com | 25或465 | 需要使用授权码 |

#### 5. 发件人配置

```yaml
email:
  from: your-email@company.com  # 【必填】发件人邮箱地址
  from-name: 服务器监控系统      # 发件人显示名称
  password: your-password       # 【必填】发件人邮箱密码或应用专用密码
```

**注意事项：**
- Gmail需要使用应用专用密码，不是普通密码
- QQ邮箱需要使用授权码，不是QQ密码
- Office365可以使用普通密码

#### 6. 收件人配置

```yaml
email:
  to: admin@company.com              # 【必填】收件人邮箱
  cc: user1@example.com,user2@example.com  # 【可选】抄送邮箱（多个用逗号分隔）
```

#### 7. 邮件主题配置

```yaml
email:
  subject:
    prefix: "[监控告警]"  # 邮件主题前缀
```

#### 8. 邮件调试模式

```yaml
email:
  debug: false  # 是否启用邮件调试模式
```

**功能说明：**
- 启用后会在控制台输出详细的SMTP通信日志
- **使用场景**：当邮件发送失败时，可以开启此选项查看详细的错误信息
- **注意**：生产环境建议关闭（false），避免日志过多

#### 9. 企业微信机器人配置

```yaml
enterprise:
  robot: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=your-webhook-key
```

**功能说明：**
- 配置企业微信机器人的Webhook URL
- 系统会优先使用企微机器人发送通知
- 如果企微发送失败（重试3次后），会自动使用邮件作为备用通知方式

**企微机器人功能：**
- ✅ **文本消息**：发送监控结果摘要
- ✅ **图片消息**：支持发送图片（JPG/PNG格式，最大2M）
- ✅ **自动重试**：发送失败时自动重试，最多3次
- ✅ **邮件备用**：企微发送失败后，自动使用邮件通知

**获取Webhook URL：**
1. 在企业微信中创建群聊机器人
2. 获取机器人的Webhook URL
3. 将URL配置到 `enterprise.robot` 中

---

## 使用指南

### 1. 启动服务

**方式一：使用Spring Boot启动（推荐）**
```bash
mvn spring-boot:run
```

**方式二：打包后运行**
```bash
mvn clean package
java -jar target/demo-0.0.1-SNAPSHOT.jar
```

### 2. 打包项目

**使用Maven打包：**
```bash
mvn clean package
```

打包完成后，会在 `target` 目录下生成 `ping-monitor-service.jar` 文件。

### 3. 部署和运行

**部署目录结构：**
```
D:\monitor\
├── ping-monitor-service.jar    # jar包（打包后从target目录复制）
├── server_list.txt              # 服务器列表（必须，和jar包同目录）
├── start.bat                     # Windows启动脚本（可选）
├── start.sh                      # Linux启动脚本（可选）
└── PingLogs\                    # 日志目录（自动创建）
    ├── 监控汇总_2026-01.xlsx
    └── 2026-01\
        └── 完整日志_2026-01-06.txt
```

**运行方式：**

**方式一：直接运行jar包**
```bash
java -jar ping-monitor-service.jar
```

**方式二：使用启动脚本（推荐）**

Windows系统：
```bash
start.bat
```

Linux系统：
```bash
chmod +x start.sh
./start.sh
```

**重要提示：**
- `server_list.txt` 必须和 `ping-monitor-service.jar` 放在**同一个目录**下
- 运行jar包时，`server_list.txt` 会在**当前工作目录**下查找
- 如果 `server_list.txt` 不存在，程序会自动创建一个示例文件
- 所有日志文件（Excel和TXT）会保存在jar包所在目录的 `PingLogs` 文件夹中

### 4. 查看日志

程序运行后，会在控制台输出监控日志：
```
========================================
  服务器Ping监控服务已启动 (JDK17)
========================================
工作目录: D:\monitor
日志目录: D:\monitor\PingLogs
监控间隔: 1小时 (3600000毫秒)
Ping超时: 3000毫秒
========================================
```

### 5. 查看监控数据

**Excel报表位置：**
```
PingLogs/监控汇总_2026-01.xlsx
```

**TXT日志位置：**
```
PingLogs/2026-01/完整日志_2026-01-06.txt
```

### 6. 停止服务

按 `Ctrl+C` 停止服务，程序会优雅关闭。

---

## 常见问题

### Q1: 邮件发送失败怎么办？

**A:** 请检查以下几点：
1. 确认 `email.enabled` 设置为 `true`
2. 检查SMTP服务器地址和端口是否正确
3. 确认邮箱密码或授权码是否正确
4. 如果是Gmail，需要使用应用专用密码
5. 开启 `email.debug: true` 查看详细错误信息

### Q2: 如何修改Ping间隔时间？

**A:** 修改 `application.yml` 中的 `monitor.ping.interval` 值：
```yaml
monitor:
  ping:
    interval: 300000  # 改为5分钟
```

### Q3: 指定时间点ping功能是干什么用的？

**A:** 当启用 `ON_FAILURE_AND_MORNING_SUMMARY` 模式时，系统会在配置的指定时间点（如早上7点）执行一次ping检测，并将结果发送到邮件。无论是否有异常都会发送，这样可以：
- 在固定时间点主动检查服务器状态
- 即使没有异常也能了解服务器当前状态
- 配合异常告警，形成完整的监控体系

### Q4: 调试模式有什么用？

**A:** 调试模式会输出详细的SMTP通信日志，包括：
- 连接过程
- 认证过程
- 发送过程
- 错误信息

当邮件发送失败时，开启调试模式可以帮助定位问题。

### Q5: Excel文件打不开怎么办？

**A:** 请检查：
1. 文件是否被其他程序占用
2. 文件是否损坏（可以尝试删除后重新生成）
3. 确保使用Excel 2007或更高版本打开

### Q6: 如何添加更多服务器？

**A:** 编辑jar包所在目录的 `server_list.txt` 文件，每行添加一个IP或域名。

### Q7: 打包后如何部署？

**A:** 
1. 执行 `mvn clean package` 打包项目
2. 将 `target/ping-monitor-service.jar` 复制到部署目录
3. 在jar包所在目录创建 `server_list.txt` 文件（或使用程序自动生成的示例文件）
4. 运行 `java -jar ping-monitor-service.jar` 启动服务
5. 所有日志文件会自动保存在jar包所在目录的 `PingLogs` 文件夹中

### Q8: 为什么找不到server_list.txt？

**A:** `server_list.txt` 必须在运行jar包时的工作目录下。确保：
- jar包和 `server_list.txt` 在同一目录
- 运行jar包时，当前工作目录就是jar包所在目录
- 如果使用启动脚本，脚本文件也应该和jar包在同一目录

### Q9: ping重试机制是如何工作的？

**A:** 系统实现了智能重试机制，工作流程如下：
- **第1次尝试**：执行ping，如果成功则直接记录成功
- **第2次尝试**：如果第1次失败（超时），等待2秒后自动重试
- **第3次尝试**：如果第2次仍失败，等待2秒后最后一次尝试
- **最终判定**：只有连续3次都失败才标记为异常并发送告警邮件

**优势：**
- 减少因临时网络波动导致的误报
- 提高监控准确性
- 自动处理偶发性网络问题

**日志示例：**
```
Ping [1/8]: 192.168.1.1 [超时] (第1次尝试)，2秒后重试
Ping [1/8]: 192.168.1.1 [正常] 5ms (第2次尝试)
```

### Q10: Excel和TXT数据写入是否需要保证事务一致性？

**A:** 系统采用了**数据安全机制**，但不需要严格的事务一致性：

**设计考虑：**
- **监控日志系统**：数据是日志性质，不是关键业务数据
- **TXT日志**：使用追加模式，写入失败不影响已有数据
- **Excel汇总**：使用**临时文件+原子替换**机制，确保写入失败时不会丢失已有数据

**Excel写入安全机制：**
1. 先写入临时文件（`.xlsx.tmp`）
2. 写入成功后，原子替换原文件
3. 如果写入失败，原文件保持不变
4. 自动清理失败的临时文件

**优势：**
- 避免因写入失败导致历史数据丢失
- 即使写入失败，下次监控仍能正常进行
- 不需要数据库事务，适合文件系统场景

### Q11: 企微机器人通知是如何工作的？

**A:** 企微机器人通知有两种发送场景，都采用"企微优先，邮件兜底"的策略：

**统一策略：企微优先，邮件兜底**
1. **优先发送企微**：优先使用企微机器人发送文本消息
2. **自动重试**：如果发送失败，自动重试，最多3次，每次间隔2秒
3. **邮件兜底**：如果3次重试都失败，自动使用邮件作为兜底通知方式

**场景一：定时监控（仅在异常时发送）**
1. **异常检测**：只有在检测到服务器异常时才会触发企微通知
2. **企微优先**：优先发送企微消息
3. **邮件兜底**：企微失败后，使用邮件发送（仅在异常时发送）

**场景二：指定时间点检查（无论成功或失败都发送）**
1. **定时检查**：在配置的指定时间点（如早上7:30）执行ping检测
2. **无条件发送**：无论检测结果是否有异常，都会发送企微消息
3. **企微优先**：优先发送企微消息
4. **邮件兜底**：企微失败后，使用邮件发送（无论成功或失败都发送）

**发送条件总结：**
- ✅ **定时监控**：仅在检测到异常时发送企微消息，失败后用邮件兜底
- ✅ **指定时间点检查**：无论成功或失败都发送企微消息，失败后用邮件兜底
- ✅ **邮件作为兜底**：只有在企微发送失败（重试3次后）时，才会使用邮件通知

**支持的消息类型：**
- **文本消息**：发送监控结果摘要（包含统计信息、异常服务器列表等）
- **图片消息**：支持发送图片（JPG/PNG格式，最大2M）

**优势：**
- 企微通知更及时，便于团队协作
- 自动重试机制提高发送成功率
- 邮件作为备用，确保重要通知不丢失

---

## 技术架构

### 技术栈

- **Java 17**：开发语言
- **Spring Boot 3.5.4**：应用框架
- **EasyExcel 3.3.4**：Excel处理
- **Jakarta Mail 2.0.1**：邮件发送
- **Lombok 1.18.24**：代码简化
- **SLF4J + Logback**：日志框架

### 项目结构

```
demo/
├── src/
│   ├── main/
│   │   ├── java/
│   │   │   └── com/example/demo/
│   │   │       ├── config/          # 配置类
│   │   │       │   ├── MonitorConfig.java
│   │   │       │   └── EmailConfig.java
│   │   │       ├── PingMonitorService.java  # 主服务类
│   │   │       ├── EmailService.java        # 邮件服务
│   │   │       ├── PingResult.java          # 数据模型
│   │   │       └── MonitorApplication.java   # 启动类
│   │   └── resources/
│   │       └── application.yml       # 配置文件
│   └── test/
├── server_list.txt                  # 服务器列表（运行时会自动创建）
├── pom.xml                          # Maven配置
└── README.md                        # 本文档
```

### 核心类说明

#### PingMonitorService
- 主监控服务类
- 负责执行ping检测、数据记录、任务调度
- 实现智能重试机制（超时时自动重试2次）

#### EmailService
- 邮件发送服务
- 支持多种邮件发送模式

#### MonitorConfig
- 监控配置类
- 读取 `monitor.*` 配置项

#### EmailConfig
- 邮件配置类
- 读取 `email.*` 配置项

---

## 配置示例

### 完整配置示例（启用“异常+早晨汇总”模式）

```yaml
spring:
  application:
    name: monitor

# Ping监控服务配置
monitor:
  ping:
    interval: 60000   # 1分钟ping一次
    timeout: 3000     # 3秒超时
  
  daily-summary:
    hour: 7           # 每天早上7点执行ping并发送结果
    minute: 0

# 邮件配置
email:
  enabled: true
  send-mode: ON_FAILURE_AND_MORNING_SUMMARY
  
  smtp:
    host: smtp.office365.com
    port: 587
    starttls-enable: true
    auth: true
  
  from: monitor@company.com
  from-name: 服务器监控系统
  password: your-password
  
  to: admin@company.com
  cc: manager@company.com
  
  subject:
    prefix: "[监控告警]"
  
  debug: false
```

---

## 更新日志

### v1.2.0 (2026-01-07)
- ✅ **新增**：企业微信机器人通知功能（支持文本消息和图片消息）
- ✅ **新增**：企微消息发送失败自动重试机制（最多3次）
- ✅ **新增**：企微发送失败后自动使用邮件作为备用通知方式
- ✅ **优化**：企微机器人消息内容格式化，包含统计摘要和异常详情

### v1.1.0 (2026-01-07)
- ✅ **新增**：ping智能重试机制（超时时自动重试2次，总共3次尝试）
- ✅ **优化**：减少因临时网络波动导致的误报
- ✅ **优化**：提高监控准确性和可靠性
- ✅ **优化**：Excel数据写入安全机制（使用临时文件+原子替换，避免写入失败时数据丢失）

### v1.0.0 (2026-01-06)
- ✅ 实现基本的ping监控功能
- ✅ 支持Excel和TXT日志记录
- ✅ 支持邮件告警
- ✅ 支持指定时间点ping功能
- ✅ 所有配置移至yml文件
- ✅ 优化配置文件注释

---

## 许可证

本项目仅供学习和内部使用。

---

## 联系方式

如有问题或建议，请联系系统管理员。
